---
title: "Introduction to mobloc, an R package for mobile location algorithms and tools"
output: 
  rmarkdown::html_vignette:
    keep_md: true 
    toc: true
self_contained: no
vignette: >
  %\VignetteIndexEntry{tmap in a nutshell}
  \usepackage[utf8]{inputenc}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Introduction

Mobile phone network data is data generated by the network of antennas owned by a mobile network operator (MNO). The MNO facilitates mobile communication and charges the corresponding costs to its customers. Most countries have more than one MNO, each of whom owns and maintains their own network of antennas. 

The data that is stored by the network is called Call Detail Records (CDR) or signalling data. CDR are used for billing purposes and only contains records about calls, SMS messages and mobile data use. Signalling data also contains records when a device moves across the network, and is primarily used for network analysis and optimisation. What type of records are stored depends on many factors, such as the network infrastructure, the network technology (3G or 4G), and the type of mobile phone. CDR and signalling data have an international standard.

Data collected from the mobile phone network do typically not contain the exact geographic location of the logged events. Instead, only the id number of the site and the antenna are included. The site refers to the construction that contains one or more antennae, e.g. a cell tower. The `mobloc` package contains a set of tools to approximate the location of mobile phone devices. For this approximation, the signal strength of the antennas are modelled. Also, the fact that the coverage areas of antennas may overlap is taken into account, as well as prior information such as land use.

Besides the mobile phone network data (CDR or signalling data), the *cellplan* is needed for the estimation of geographic locations. It contains the metadata of the antennas. The number of variables that are included may vary. The more variables included, the better. The only required variables are the latitude and longitude of the antennas. Other useful variables are: direction, height, (horizontal) tilt, horizontal beam width, vertical beam width, and power. These variables are used in `mobloc` to approxiamate the location of mobile phone devices. There may be other, more advanced, variables that are useful to estimate the geographic location, such as *Timing Advance*. There are no methods implemented yet to use these variables. Also *Best Server Maps* (BSM) cannot be used as a source, but they can be used for validation. The `mobloc` package models BSM, which can be compared to the BSM of the MNO.

The methods used in this package are described in [1], which is recommended to read first. Note that this document is a little outdated: this package is already more advanced. A paper on the methods of mobloc will be available soon (expected round April 2019).


```{r echo=FALSE, message=FALSE}
library(mobloc)
```

## Setup signal strength model parameters

The first step to apply the approximate the geographic locations, is to determine the parameters for the signal propagation model. The default parameters can be loaded with the function `prop_param`. The result is a standard list:

```{r}
ZL_param <- prop_param(ple_0 = 3.5, ple_1 = 4, range = 7500)
```

A short description of the parameters is provided in the table below. These parameters are used to model the signal strenght. Most parameters are default values for parameters that are often unknown. For imputing unkown parameters, we consider two types of antennas: normal antennas, which are placed in cell towers or on roof tops, and small cells, which are placed indoors or in dense urban areas (e.g. on street lights). Since these two types antenans of antennas have very different characteristics, they also have different default values. E.g. the power of a normal antenna is set to 10 Watt for normal antennas and 5 Watt for small cells.

The following table describes the parameters. More detailed information can be found in [1].

| Parameter     |  Description  (related to signal strength) |
| ------------- |:-------------------------------------------------------------------------|
| W      | Power in Watt of a normal antenna |
| W_small      | Power in Watt of a small cell antenna |
| ple      | Power in Watt of a small cell antenna |
| ple_small      | Power in Watt of a small cell antenna |
| ple_0      | Power in Watt of a small cell antenna |
| ple_1      | Power in Watt of a small cell antenna |
| azim_min3dB      | Horizontal beam width $\gamma_j$ in [1]) |
| azim_dB_back      | Signal strength at the back of the cell in the azimuth plane |
| elev_min3dB      | Vertical beam width $\theta_j$ in [1]) |
| elev_dB_back     | Signal strength at the back of the cell in the elevation plane |
| db_mid      | Midpoint of the logistic transformation ($S^{mid}$ in [1]) |
| db_width      | Width of the logistic transformation ($S^{width}$ in [1]) |
| range      | Maximum range of normal antennas |
| range_small      | Maximum range of small cells  |
| height      | Height of a normal antenna (above ground level) |
| height_small      | Height of a small cell (above ground level)  |
| tilt      | Tilt of an antenna |
| beam_v      | Vertical beam width |
| beam_h      | Horizontal beam width |
| dBm_th      | Signal strength threshold (in dBm) |
| max_overlapping_cells      | Maximum amount of antennas that have overlapping coverage areas |

The `mobloc` package contains a tool in which these parameters can be tuned. This tool is started as follows:

```{r eval = FALSE}
setup_prop_model()
```

<img src="images/prop_model_setup.jpg" alt="sigma" data-toggle="tooltip" data-placement="right" title="" data-original-title="Note this is just a screenshot of the tool." onload="$(this).tooltip()" width="700px">

This tool models the propagation for one antenna. The left hand side panel shows the settings of this. By default these parameters are taken from the parameter list created with `prop_param`. When 'small cell` is ticked 

The plots on the righ hand side show the propagation results. The top right plot shows the top view of the signal strength of the antenna. For normal antennas, the direction in this plot is east. Small cells are omniirectional. 

The next input boxes on the leftside of the screen configure the antennas These parameters are often contained in the cellplan. If not, the default parameters can be used. The first parameter is `W_tower` or `W_small` depending on whether the *small cell* checkbox is ticked. Notice that different default settings are used, since antennas contained in cell towers and on rooftop are often much stronger than small cells. The top left plot below the heatmap shows the signal loss as a function of the distance (see equation (4) in [1]).

The next two input boxes contain the -3dB angles and dB back values for both the horizontal (azimuth) and vertical (elevation) planes. The radiation area of an antenna can be seen as a three dimensional bulb. In the main direction (e.g. the direction in which the antenna radiates) there is no loss in signal strength, irrespective of the distance. However, at a certain offset, there is signal loss. The -3dB angle is the angle at which the signal is halved. These angles (both for the horizontal and vertical plane) are usually contained in the cellplan. The dB back points are signal loss ratios between the front and the back of the antenna The two plots the the right bottom of the screen illustrate the radiation pattern in the horizontal/azimuth plane the the vertical/elevation plane. The black contour lines indicate the signal loss as a function of the offset angle. The red points are the -3dB points. These radiation plots can also be generated directly in R:

```{r eval=FALSE}
radiation_plot(beam_width = 65, db_back = -30)
radiation_plot(type = "e", db_back = -30, beam_width = 9)
```


The output type sets the type of radiation plot that is shown in the heatmap. dBm means the absolute signal strength value, and the likelihood the likelihood of connection, given the abolute signal strength values. 

The transformation from absolute signal strength values to the likelood values is achieved by applying a logistic function, which is parameterized by `dm_mid` ($S^{mid}$ in [1]) and and `db_width` ($S^{width}$ in [1]). The reason to apply such a transformation is that the probability of connection not only depends on the signal strength, but also on load balancing. For load balancing, the tails of the distribution are less important, e.g. whether a signal is very good (say -80dBm) or superb (say -70 dBm) is less important than the availability of that antenna. The transformation function is plotted in the top right chart below the heatmap. The transformation is defined in equations (6) and (7) of [1].

## Loading artificial cellplan data

When the parameters have been set, the model can be applied to cellplan data. To illustrate the model, we included artificial data to this package. This data can be loaded as follows:

```{r}
data("ZL_cellplan", "ZL_muni", "ZL_elevation", "ZL_landuse")
#ZL_cellplan <- readRDS("sandbox/cp_ZL.RDS")
#ZL_cellplan <- ZL_cellplan[substr(ZL_cellplan$antenna,1,3) == "MAA",]
```

It is artifical cellplan data from the NUTS3 region Zuid-Limburg, the most southern part of the Netherlands, which is roughly 30 by 30 kilometres large. 

The object `ZL_cellplan` is an `sf` object (see packge `sf`) that contains all the geopgraphic locations of the antennas and the metadata.

```{r}
head(ZL_cellplan)
```

The object `ZL_land` is a large multipolygon that defines the area. The object `ZL_elevation` is a `raster` object that contains the elevation heigths at 100 by 100 metre detail.

These example data can be plot with the `tmap` package

```{r eval=FALSE}
library(tmap)
tmap_mode("view")
qtm(ZL_elevation) + qtm(ZL_muni, fill=NULL) + qtm(ZL_cellplan)
```

<img src="images/ZL_data.jpg" alt="sigma" data-toggle="tooltip" data-placement="right" title="" data-original-title="Note this is just a screenshot of the interactive map." onload="$(this).tooltip()">

The object `ZL_landuse` is a raster object that contains fractions of land that is used for several categories. We will use this information later on to determine the level of urbanization per antenna and to define prior information.

```{r}
ZL_envir <- combine_raster_layers(ZL_landuse, weights = c(1, 1, 1, 0, 0)) 
```

The function `validate_cellplan` should be used to validate the cellplan. It checks if required variables are present. Variables that are not required as input, but needed for further analysis are imputed. For instance, if `tilt` is missing, it is imputed by the default value `ZL_param$tilt`. Also, 


```{r}
ZL_cellplan <- validate_cellplan(ZL_cellplan, param = ZL_param, region = ZL_muni, envir = ZL_envir, elevation = ZL_elevation)
```


The corresponding bounding box of Zuid-Limburg is created as follows.

```{r}
library(sf)
ZL_bbox <- st_bbox(c(xmin = 172700, ymin = 306800, xmax = 204800, ymax = 342700), crs = st_crs(28992))
```

## Modelling the signal propagation

In the next stage, the signal propagation is modelled. This is done with rasterization, i.e. all spatial objects are transformed into small raster cells, e.g. of 100 by 100 meters. This is mainly done for computational reasons. The raster is created as follows:

```{r eval=FALSE}
# create a raster of 100 by 100 meter cells
ZL_raster <- create_raster(ZL_bbox)
```

This object is a `raster` object that contains the raster id values, which are numbered from top left to bottom right row-wise.

For each raster cell $g$ and antenna $a$ where $g$ intersects with the polygon of $a$, the following variables are computed: the distance, the modelled signal strength, the relative signal strength, and the liklihood value. The function for these calculations, called `process_cellplan`, supports parallel computing. This requires the packages `parallel` and `doParallel`


```{r eval=FALSE}
# create a parallel cluster
require(parallel)
require(doParallel)
ncores <- detectCores()
cl <- makeCluster(ncores)
registerDoParallel(cl)

# calculate probabilities
ZL_prop <- process_cellplan(cp = ZL_cellplan, raster = ZL_raster, elevation = ZL_elevation, param = ZL_param)

# stop the cluster
stopCluster(cl)
```

The result is a `data.frame` that contains information about the modelled propagation (that is were the abbreviation `prop` stands for). It has the following columns: 

* `Cell_name` The identification numbers or names of the antennas.
* `rid` Raster cell id number. These are numbered according to the cells of specified raster object, in our example `ZL_raster`. The first number corresponds to the top left cell, and the sequence of numbers is row-wise.
* `dist` Distance from the antenna location to the center of the grid cell.
* `dBm` Signal strength in dBm.
* `s` The relative signal strength. The signal strength (dBm) is 
* `pag` The likelihood value. More speficically, it is the probability that a certain antenna is used given that the device is located in a certain the grid cell.

## Mobile location approximation

The propagation results, in our example `ZL_prop`, contains the propagation and likelihood values. In order to approximate the location of mobile devices, prior information can be used additionally. For each raster cell, a probability is assigned based on prior knowledge such as land use.

In this example, we propose four priors:

* A uniform prior. In this prior, every raster cell has the same probability. So no additional information is used.
* A land use prior. The probability depends on the land use. The general philosophy behind this approach is that in urban areas, it is more likely to espect people than in rural areas. In the example below, we use a simple land use prior, namely the fraction of land that is used for residential areas. This is stored in the raster object `ZL_resi`.
* A network prior. The antennas are not placed without reason: an MNO (mobile network operator) will probably place more antennas in dense areas. This information can be seen as prior information. We will extract this information from the propagation model.
* Composite prior. Since each of the previous priors have pros and cons, it may be worthwile to create a composite prior in order to find good balance.

```{r eval=FALSE}
ZL_uniform_prior <- create_uniform_prior(ZL_raster)
ZL_network_prior <- create_network_prior(ZL_prop, ZL_raster)
ZL_landuse_prior <- create_prior(ZL_landuse, weights = c(1, 1, .1, 0, .5))
```

```{r eval=FALSE}
ZL_coverage_map <- create_coverage_map(ZL_prop, ZL_raster)
ZL_best_server_map <- create_best_server_map(ZL_prop, ZL_raster)
```



```{r eval=FALSE}
explore_mobloc(ZL_cellplan, ZL_raster, ZL_prop, list(landuse = ZL_landuse_prior, network = ZL_network_prior, uniform = ZL_uniform_prior),  ZL_param)
```


```{r eval=FALSE}
ZL_comp_prior <- create_prior(ZL_network_prior, ZL_landuse_prior, weights = c(.25, .75))

ZL_pga <- calculate_mobloc(ZL_prop, prior = ZL_comp_prior, raster = ZL_raster)
```

<img src="images/cell_inspection_tool.jpg" alt="sigma" data-toggle="tooltip" data-placement="right" title="" data-original-title="Note this is just a screenshot of the interactive map." onload="$(this).tooltip()">


## Reference
[1] Tennekes, M., 2018, Geographic Location of Mobile Phone Events, [`vignette("geographic location events")`](../doc/geographic-location-events.pdf)

